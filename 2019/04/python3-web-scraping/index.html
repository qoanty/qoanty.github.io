<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta name="generator" content="Hugo 0.54.0" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <title>Python3 学习笔记（异步爬虫） | 百年孤独的博客</title>
    <meta property="og:title" content="Python3 学习笔记（异步爬虫） - 百年孤独的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content="2019-04-21T21:06:02&#43;08:00">
        
        
    <meta property="article:modified_time" content="2019-04-21T21:06:02&#43;08:00">
        
    <meta name="Keywords" content="VPS, python, android, 博客, 小程序">
    <meta name="description" content="Python3 学习笔记（异步爬虫）">
        
    <meta name="author" content="百年孤独">
    <meta property="og:url" content="https://qoanty.github.io/2019/04/python3-web-scraping/">
    <link rel="shortcut icon" href="/favicon.ico" type="image/x-icon">

    <link rel="stylesheet" href="/css/normalize.css">
    
        <link rel="stylesheet" href="/css/prism.css">
    
    <link rel="stylesheet" href="/css/style.css">
    <script type="text/javascript" src="//cdn.bootcss.com/jquery/3.2.1/jquery.min.js"></script>

    


    
    
</head>

<body>
<header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://qoanty.github.io/">
                        百年孤独的博客
                    </a>
                
                <p class="description">艺术家用谎言揭露真相，政治家用谎言隐瞒真相</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="" href="https://qoanty.github.io/">首页</a>
                    
                    <a  href="https://qoanty.github.io/tools/" title="工具">工具</a>
                    
                    <a  href="https://qoanty.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://qoanty.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>


<div id="body">
    <div class="container">
        <div class="col-group">

            <div class="col-8" id="main">
                <div class="res-cons">
                    <article class="post">
                        <header>
                            <h1 class="post-title">Python3 学习笔记（异步爬虫）</h1>
                        </header>
                        <date class="post-meta meta-date">
                            2019年4月21日
                        </date>
                        
                        <div class="post-meta">
                            <span>|</span>
                            
                                <span class="meta-category"><a href="https://qoanty.github.io/categories/learn">Learn</a></span>
                            
                                <span class="meta-category"><a href="https://qoanty.github.io/categories/python">Python</a></span>
                            
                        </div>
                        
                        
                        
                        <div class="post-content">
                            <p>异步爬虫不同于多进程爬虫，它使用单线程(即仅创建一个事件循环，然后把所有任务添加到事件循环中)就能并发处理多任务。在轮询到某个任务后，当遇到耗时操作(如请求URL)时，挂起该任务并进行下一个任务，当之前被挂起的任务更新了状态(如获得了网页响应)，则被唤醒，程序继续从上次挂起的地方运行下去。极大的减少了中间不必要的等待时间。</p>

<p>有了<code>Asyncio</code>异步IO库实现协程后，我们还需要实现异步网页请求。普通的爬虫程序会经常用到requests库用以请求网页并获得服务器响应。而在协程中，由于requests库提供的相关方法不是可等待对象（awaitable），使得无法放在<code>await</code>后面，因此无法使用requests库在协程程序中实现请求。</p>

<p>官方专门提供了一个<code>aiohttp</code>库，用来实现异步网页请求等功能，简直就是异步版的requests库。在协程中使用<code>ClientSession()</code>的<code>get()</code>或<code>request()</code>方法来请求网页（其中<code>async with</code>是异步上下文管理器，其封装了异步实现等功能），完整的<code>aiohttp</code>使用方法，请见<a href="https://aiohttp.readthedocs.io/en/stable/client_quickstart.html">官方文档</a>。</p>

<pre><code class="language-python">import aiohttp
async with aiohttp.ClientSession() as session:
    async with session.get('http://httpbin.org/get') as resp:
        print(resp.status)
        print(await resp.text())
</code></pre>

<p>官方API提供的HTTP常见方法：</p>

<pre><code class="language-python">session.post('http://httpbin.org/post', data=b'data')
session.put('http://httpbin.org/put', data=b'data')
session.delete('http://httpbin.org/delete')
session.head('http://httpbin.org/get')
session.options('http://httpbin.org/get')
session.patch('http://httpbin.org/patch', data=b'data')
</code></pre>

<p>实例：获取各主要集团招投标平台的标题</p>

<pre><code class="language-python">from bs4 import BeautifulSoup as bs
import requests
import time
import aiohttp
import asyncio

allBids = {
    '采购与招标网': 'https://www.chinabidding.cn/',
    '招投标平台': 'http://bulletin.cebpubservice.com/',
    '华能招标网': 'http://ec.chng.com.cn/ecmall/',
    '神华招标网': 'http://www.shenhuabidding.com.cn/bidweb/',
    '中广核招标网': 'https://ecp.cgnpc.com.cn/',
    '三峡招标网': 'http://epp.ctg.com.cn/',
    '大唐招标网': 'http://www.cdt-ec.com/home/',
    '守正招标网': 'https://szecp.crc.com.cn/',
    '国电投招标网': 'http://www.cpeinet.com.cn/',
    '国电招标网': 'http://www.cgdcbidding.com/',
    '华电招标网': 'https://www.chdtp.com/',
    '河北招标网': 'http://hebeibidding.com/TPFront/default.aspx',
    '协合招标网': 'http://www.cnegroup.com/'
}
headers = {'User-Agent': 'Mozilla/4.0 (compatible; MSIE 5.5; Windows NT)'}
sem = asyncio.Semaphore(5)  # 限制同时运行协程数量

# 按顺序获取标题
def get_title_normal():
    session = requests.session()
    for name, url in allBids.items():
        html = session.get(url, headers=headers)
        html.encoding = 'utf-8'
        title = bs(html.text, 'lxml').find('title').text
        print(title)

# 协程异步获取标题
async def get_title_asyn(url):
    with (await sem):
        async with aiohttp.ClientSession() as session:  # 获取session
            async with session.get(url, headers=headers) as resp:  # 提出请求
                # 断言，判断网站状态
                assert resp.status == 200
                html = await resp.text()
                soup = bs(html, 'lxml')
                title = soup.find('title').text
                print(''.join(title))


def loops():
    loop = asyncio.get_event_loop()  # 获取事件循环
    # 把所有任务放到一个列表中
    tasks = [get_title_asyn(url) for name, url in allBids.items()]
    loop.run_until_complete(asyncio.wait(tasks))  # 激活协程
    loop.close()  # 关闭事件循环


if __name__ == '__main__':
    print(time.strftime('%Y-%m-%d %H:%M:%S'))
    start = time.time()
    # get_title_normal()
    loops()
    print('总耗时: %.2f秒' % float(time.time()-start))
</code></pre>

                        </div>

                        


                        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2019/04/python3-asyncio/">Python3 学习笔记（异步IO）</a></li>
        
        <li><a href="/2019/04/python3-built-in-functions-modules/">Python3 学习笔记（内建模块）</a></li>
        
        <li><a href="/2019/04/python3-distributed-processes/">Python3 学习笔记（分布式进程）</a></li>
        
        <li><a href="/2019/04/python3-object-oriented-programming/">Python3 学习笔记（面向对象编程）</a></li>
        
        <li><a href="/2019/04/python3-functional-programming/">Python3 学习笔记（函数式编程）</a></li>
        
    </ul>
</div>


                        <div class="post-meta meta-tags">
                            
                            <ul class="clearfix">
                                
                                <li><a href="https://qoanty.github.io/tags/python">python</a></li>
                                
                                <li><a href="https://qoanty.github.io/tags/scraping">scraping</a></li>
                                
                            </ul>
                            
                        </div>
                    </article>
                    
    

    
    
    <div class="post bg-white">
      <script src="https://utteranc.es/client.js"
            repo= "qoanty/qoanty.github.io"
            issue-term="pathname"
            theme="github-light"
            crossorigin="anonymous"
            async>
      </script>
    </div>
    
                </div>
            </div>
            <div id="secondary">
    <section class="widget">
        <form id="search" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://qoanty.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://qoanty.github.io/2019/05/sliding-captcha/" title="极验滑动验证码识别">极验滑动验证码识别</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-web-scraping/" title="Python3 学习笔记（异步爬虫）">Python3 学习笔记（异步爬虫）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-asyncio/" title="Python3 学习笔记（异步IO）">Python3 学习笔记（异步IO）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-built-in-functions-modules/" title="Python3 学习笔记（内建模块）">Python3 学习笔记（内建模块）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-distributed-processes/" title="Python3 学习笔记（分布式进程）">Python3 学习笔记（分布式进程）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-object-oriented-programming/" title="Python3 学习笔记（面向对象编程）">Python3 学习笔记（面向对象编程）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-functional-programming/" title="Python3 学习笔记（函数式编程）">Python3 学习笔记（函数式编程）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-advanced-features/" title="Python3 学习笔记（高级特性）">Python3 学习笔记（高级特性）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/python3-functions/" title="Python3 学习笔记（函数）">Python3 学习笔记（函数）</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/04/wss-and-web/" title="基于V2Ray的WebSocket&#43;TLS&#43;Web&#43;CDN安全网络代理">基于V2Ray的WebSocket&#43;TLS&#43;Web&#43;CDN安全网络代理</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title">分类</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://qoanty.github.io/categories/blog/">Blog(1)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/captcha/">Captcha(1)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/hugo/">Hugo(1)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/learn/">Learn(8)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/python/">Python(10)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/v2ray/">V2Ray(2)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/vps/">VPS(2)</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/categories/vim/">Vim(1)</a>
    </li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title">标签</h3>
<div class="tagcloud">
    
    <a href="https://qoanty.github.io/tags/cdn/">CDN</a>
    
    <a href="https://qoanty.github.io/tags/github/">Github</a>
    
    <a href="https://qoanty.github.io/tags/hugo/">Hugo</a>
    
    <a href="https://qoanty.github.io/tags/ide/">IDE</a>
    
    <a href="https://qoanty.github.io/tags/oop/">OOP</a>
    
    <a href="https://qoanty.github.io/tags/v2ray/">V2Ray</a>
    
    <a href="https://qoanty.github.io/tags/vps/">VPS</a>
    
    <a href="https://qoanty.github.io/tags/asyncio/">asyncio</a>
    
    <a href="https://qoanty.github.io/tags/features/">features</a>
    
    <a href="https://qoanty.github.io/tags/functions/">functions</a>
    
    <a href="https://qoanty.github.io/tags/geetest/">geetest</a>
    
    <a href="https://qoanty.github.io/tags/processes/">processes</a>
    
    <a href="https://qoanty.github.io/tags/python/">python</a>
    
    <a href="https://qoanty.github.io/tags/scraping/">scraping</a>
    
    <a href="https://qoanty.github.io/tags/vim/">vim</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://python3-cookbook.readthedocs.io/zh_CN/latest/index.html" title="Python Cookbook 3rd Edition">Python Cookbook</a>
        </li>
        
        <li>
            <a target="_blank" href="https://seancheney.gitbook.io/python-for-data-analysis-2nd/" title="Python for Data Analysis 2nd Edition">Python for Data Analysis</a>
        </li>
        
        <li>
            <a target="_blank" href="https://codelabs.developers.google.com/codelabs/cloud-tensorflow-mnist/#0" title="TensorFlow and deep learning, without a PhD">TensorFlow and deep learning</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://qoanty.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
        </div>
    </div>
</div>
<footer id="footer">
    <div class="container">
        &copy; 2019 <a href="https://qoanty.github.io/">百年孤独的博客 By 百年孤独</a>.
        Powered by <a rel="nofollow noreferer noopener" href="https://gohugo.io" target="_blank">Hugo</a> & <a href="https://github.com/rujews/maupassant-hugo" target="_blank">maupassant</a>.
        
    </div>
</footer>


    <script type="text/javascript">
    
    (function(){
        $("pre code").parent().addClass("line-numbers")
    }())

    window.MathJax = {
        tex2jax: {
            inlineMath: [ ['$','$'] ],
            processEscapes: true
        }
    };
    </script>
    <script type="text/javascript" src="/js/prism.js" async="true"></script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src="/js/totop.js?v=0.0.0" async=""></script>







</body>
</html>
