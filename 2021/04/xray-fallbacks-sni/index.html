<!doctype html>
<html lang="zh-CN">
<head>

    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    

    <title>Xray通过SNI回落功能实现伪装与按域名分流 | 百年孤独的博客</title>
    <meta property="og:title" content="Xray通过SNI回落功能实现伪装与按域名分流 - 百年孤独的博客">
    <meta property="og:type" content="article">
        
    <meta property="article:published_time" content='2021-04-28T20:43:33&#43;08:00'>
        
        
    <meta property="article:modified_time" content='2021-04-28T20:43:33&#43;08:00'>
        
    <meta name="Keywords" content="VPS, python, android, 博客, 小程序">
    <meta name="description" content="Xray通过SNI回落功能实现伪装与按域名分流">
        
    <meta name="author" content="百年孤独">
    <meta property="og:url" content="https://qoanty.github.io/2021/04/xray-fallbacks-sni/">
    <link rel="shortcut icon" href='/favicon.ico'  type="image/x-icon">

    <link rel="stylesheet" href='/css/normalize.css'>
    <link rel="stylesheet" href='/css/style.css'>
    <script type="text/javascript" src="//cdn.bootcdn.net/ajax/libs/jquery/3.4.1/jquery.min.js"></script>

    
    
    
    
    
    
</head>


<body>
    <header id="header" class="clearfix">
    <div class="container">
        <div class="col-group">
            <div class="site-name ">
                
                    <a id="logo" href="https://qoanty.github.io/">
                        百年孤独的博客
                    </a>
                
                <p class="description">艺术家用谎言揭露真相，政治家用谎言隐瞒真相</p>
            </div>
            <div>
                <nav id="nav-menu" class="clearfix">
                    <a class="current" href="https://qoanty.github.io/">首页</a>
                    
                    <a  href="https://qoanty.github.io/tools/" title="工具">工具</a>
                    
                    <a  href="https://qoanty.github.io/archives/" title="归档">归档</a>
                    
                    <a  href="https://qoanty.github.io/about/" title="关于">关于</a>
                    
                </nav>
            </div>
        </div>
    </div>
</header>

    <div id="body">
        <div class="container">
            <div class="col-group">

                <div class="col-8" id="main">
                    
<div class="res-cons">
    
    <article class="post">
        <header>
            <h1 class="post-title">Xray通过SNI回落功能实现伪装与按域名分流</h1>
        </header>
        <date class="post-meta meta-date">
            2021年4月28日
        </date>
        
        <div class="post-meta">
            <span>|</span>
            
            <span class="meta-category"><a href='/categories/sni'>SNI</a></span>
            
            <span class="meta-category"><a href='/categories/xray'>xray</a></span>
            
        </div>
        
        
        
        <div class="post-content">
            <p>VLESS是一种很轻的协议，和Trojan一样，不对流量进行复杂的加密和混淆，而是通过TLS协议加密，混杂在其他HTTPS流量中，在墙内外穿进穿出。为了更好的伪装以应对主动探测，Fallbacks回落功能随VLESS同时出现。本文将演示如何使用Xray中VLESS入站协议的回落功能配合Nginx或Caddy在保证伪装完全的前提下实现按域名分流。</p>
<h2 id="应用情景">应用情景</h2>
<p>由于XTLS，Xray需要监听443端口，这导致如果之前有网站运行在服务器上，那么此时网站无法运行或需要运行在其他端口上，这显然是不合理的。有以下三种方案可以解决这个问题：</p>
<ul>
<li>
<p>Xray监听其他常用端口（如22、3389、8443），这个方案是最简单的，但不够完美。</p>
</li>
<li>
<p>Nginx或HAProxy监听443端口，通过SNI分流做L4反向代理，实现端口复用，这个方案比较复杂，需要对Nginx或HAProxy的使用有一定了解，此处不作过多解释。</p>
</li>
<li>
<p>Xray监听443端口，通过Fallbacks功能SNI分流将网站流量回落到Nginx或Caddy，这个方案难度适中，也是本文接下来要演示的方案。</p>
</li>
</ul>
<h2 id="sni简介">SNI简介</h2>
<p>服务器名称指示（英语：Server Name Indication，缩写：SNI）是TLS的一个扩展协议。熟悉反向代理的人知道，如果想要通过域名将流量代理到正确的内容上，需要以下配置：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#000;font-weight:bold">proxy_set_header</span> <span style="color:#d14">Host</span> <span style="color:#d14">主机名</span>;
</code></pre></td></tr></table>
</div>
</div><p>这句的作用是将名为“Host”的HTTP Header设定为某个主机名。为什么要这样做？一般而言，一台服务器对应一个IP，但却运行多个网站，访问者通过域名查询到IP以访问服务器，那么问题来了，如何确定访问者想要访问的是哪一个网站？这需要“基于名称的虚拟主机”。</p>
<p>当Web服务器收到访问请求后，它会查看请求的主机头，使访问者访问正确的网站。然而当HTTP协议被TLS协议加密后，这种简单的方法就无法实现了。因为TLS握手发生在服务器看到任何HTTP头之前，因此，服务器不可能使用HTTP主机头中的信息来决定呈现哪个证书，更无法决定访问者的访问目标。</p>
<p>SNI的原理也很简单，它通过让客户端发送主机名作为TLS协商的一部分来解决此问题。所以在使用Nginx对HTTPS协议进行反向代理时，需要在配置中加入<code>proxy_ssl_server_name on;</code>，此时Nginx会向被代理的服务器发送SNI信息，解决了HTTPS协议下虚拟主机失效的问题。另外，使用SNI时，即使不指定主机头，也可以正确访问网站。</p>
<h2 id="思路">思路</h2>
<p>
        <img class="mx-auto" alt="" src="/images/sni1.png" />   
    </p>
<p>从443端口接收到流量后，Xray会把TLS解密后首包长度小于18、协议版本无效或身份认证失败的流量通过对name、path、alpn的匹配转发到dest指定的地址。</p>
<h2 id="添加dns记录">添加DNS记录</h2>
<p>
        <img class="mx-auto" alt="" src="/images/sni2.png" />   
    </p>
<p>请按实际情况修改域名和IP。</p>
<h2 id="申请tls证书">申请TLS证书</h2>
<p>由于要对不同前缀的域名进行分流，但一个通配符证书的作用域仅限于两“.”之间（例如：申请<code>*.example.com，example.com</code>和<code>*.*.example.com</code>并不能使用该证书），故需申请SAN通配符证书。根据Let’s Encrypt官网信息，申请通配符证书要求DNS-01验证方式，此处为NS记录为Cloudflare的域名通过<a href="https://acme.sh/">acme.sh</a>申请Let’s Encrypt的免费TLS证书。使用其他域名托管商的申请方法见<a href="https://github.com/acmesh-official/acme.sh/wiki/dnsapi">dnsapi · acmesh-official/acme.sh Wiki</a>。</p>
<p>首先需要到<a href="https://dash.cloudflare.com/profile/api-tokens">Cloudflare面板</a>创建API Token。参数如下：</p>
<p>
        <img class="mx-auto" alt="" src="/images/sni3.png" />   
    </p>
<p>权限部分至关重要，其他部分任意。</p>
<p>创建完毕后，你会得到一串神秘字符，请将其妥善保管到安全且不会丢失的地方，因为它不再会显示。这串字符就是即将用到的<code>CF_Token</code>。</p>
<p>注意：以下操作需要在root用户下进行，使用sudo会出现错误。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">curl https://get.acme.sh | sh <span style="color:#998;font-style:italic"># 安装 acme.sh</span>
<span style="color:#0086b3">export</span> <span style="color:#008080">CF_Token</span><span style="color:#000;font-weight:bold">=</span><span style="color:#d14">&#34;t2pOuNSg7r9lnqgmyHcQ48FA1FdZPw&#34;</span> <span style="color:#998;font-style:italic"># 设定API Token变量</span>
acme.sh --issue -d example.com -d *.example.com --keylength ec-256 --dns dns_cf <span style="color:#998;font-style:italic"># 使用DNS-01验证方式申请证书</span>
mkdir /usr/local/ssl/xray <span style="color:#998;font-style:italic"># 新建证书存放目录</span>
acme.sh --install-cert -d example.com --ecc --fullchain-file /usr/local/ssl/xray/cert.pem --key-file /usr/local/ssl/xray/privkey.key --reloadcmd <span style="color:#d14">&#34;chown xray:xray -R /usr/local/ssl/xray &amp;&amp; systemctl restart xray&#34;</span> <span style="color:#998;font-style:italic"># 安装证书到指定目录并设定自动续签生效指令</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="xray配置">Xray配置</h2>
<p>针对Nginx的配置为：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">38
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">39
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">40
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">41
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">42
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">43
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">44
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">45
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">46
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">47
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">48
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">49
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">50
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">51
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">52
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">53
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">54
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">55
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">56
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">57
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">58
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">59
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">60
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">61
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">62
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">63
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">64
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">65
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">66
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">67
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">68
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">69
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">70
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">71
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">72
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">73
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">74
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">75
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">76
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">77
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">78
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">79
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">80
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">81
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">82
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">83
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">84
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">85
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">86
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">87
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">88
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json">{
  <span style="color:#000080">&#34;log&#34;</span>: {
    <span style="color:#000080">&#34;loglevel&#34;</span>: <span style="color:#d14">&#34;warning&#34;</span>
  },
  <span style="color:#000080">&#34;inbounds&#34;</span>: [
    {
      <span style="color:#000080">&#34;port&#34;</span>: <span style="color:#099">443</span>,
      <span style="color:#000080">&#34;protocol&#34;</span>: <span style="color:#d14">&#34;vless&#34;</span>,
      <span style="color:#000080">&#34;settings&#34;</span>: {
        <span style="color:#000080">&#34;clients&#34;</span>: [
          {
            <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;UUID&#34;</span>,
            <span style="color:#000080">&#34;flow&#34;</span>: <span style="color:#d14">&#34;xtls-rprx-direct&#34;</span>
          }
        ],
        <span style="color:#000080">&#34;decryption&#34;</span>: <span style="color:#d14">&#34;none&#34;</span>,
        <span style="color:#000080">&#34;fallbacks&#34;</span>: [
          {
            <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;ws.example.com&#34;</span>,
            <span style="color:#000080">&#34;path&#34;</span>: <span style="color:#d14">&#34;/vmessws&#34;</span>,
            <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6000</span>,
            <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
          },
          {
            <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6001</span>,
            <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
          },
          {
             <span style="color:#000080">&#34;alpn&#34;</span>: <span style="color:#d14">&#34;h2&#34;</span>,
             <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6002</span>,
             <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
          },
          {
            <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;example.com&#34;</span>,
            <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6003</span>,
            <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
          },
          {
            <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;example.com&#34;</span>,
            <span style="color:#000080">&#34;alpn&#34;</span>: <span style="color:#d14">&#34;h2&#34;</span>,
            <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6004</span>,
            <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
          }
        ]
      },
      <span style="color:#000080">&#34;streamSettings&#34;</span>: {
        <span style="color:#000080">&#34;network&#34;</span>: <span style="color:#d14">&#34;tcp&#34;</span>,
        <span style="color:#000080">&#34;security&#34;</span>: <span style="color:#d14">&#34;xtls&#34;</span>,
        <span style="color:#000080">&#34;xtlsSettings&#34;</span>: {
          <span style="color:#000080">&#34;alpn&#34;</span>: [
            <span style="color:#d14">&#34;h2&#34;</span>,
            <span style="color:#d14">&#34;http/1.1&#34;</span>
          ],
          <span style="color:#000080">&#34;certificates&#34;</span>: [
            {
              <span style="color:#000080">&#34;certificateFile&#34;</span>: <span style="color:#d14">&#34;/usr/local/ssl/xray/cert.pem&#34;</span>,
              <span style="color:#000080">&#34;keyFile&#34;</span>: <span style="color:#d14">&#34;/usr/local/ssl/xray/privkey.key&#34;</span>
            }
          ]
        }
      }
    },
    {
      <span style="color:#000080">&#34;port&#34;</span>: <span style="color:#099">6000</span>,
      <span style="color:#000080">&#34;listen&#34;</span>: <span style="color:#d14">&#34;127.0.0.1&#34;</span>,
      <span style="color:#000080">&#34;protocol&#34;</span>: <span style="color:#d14">&#34;vmess&#34;</span>,
      <span style="color:#000080">&#34;settings&#34;</span>: {
        <span style="color:#000080">&#34;clients&#34;</span>: [
          {
            <span style="color:#000080">&#34;id&#34;</span>: <span style="color:#d14">&#34;UUID&#34;</span>
          }
        ]
      },
      <span style="color:#000080">&#34;streamSettings&#34;</span>: {
        <span style="color:#000080">&#34;network&#34;</span>: <span style="color:#d14">&#34;ws&#34;</span>,
        <span style="color:#000080">&#34;wsSettings&#34;</span>: {
          <span style="color:#000080">&#34;acceptProxyProtocol&#34;</span>: <span style="color:#000;font-weight:bold">true</span>,
          <span style="color:#000080">&#34;path&#34;</span>: <span style="color:#d14">&#34;/vmessws&#34;</span>
        }
      }
    }
  ],
  <span style="color:#000080">&#34;outbounds&#34;</span>: [
    {
      <span style="color:#000080">&#34;protocol&#34;</span>: <span style="color:#d14">&#34;freedom&#34;</span>
    }
  ]
}
</code></pre></td></tr></table>
</div>
</div><ol>
<li>有关Proxy Protocol</li>
</ol>
<p>Proxy Protocol是HaProxy开发的一种旨在解决代理时容易丢失客户端信息问题的协议，常用于链式代理和反向代理。传统的处理方法往往较为复杂且有诸多限制，而Proxy Protocol非常简单地在传输数据时附带上原始连接四元组信息的数据包，解决了这个问题。</p>
<p>凡事皆有利弊，Proxy Protocol也是如此。</p>
<ul>
<li>有发送必须有接收，反之亦然</li>
<li>同一端口不能既兼容带Proxy Protocol数据的连接又兼容不带数据的连接（如：Nginx同端口的不同虚拟主机（server），本质是上一条）</li>
</ul>
<p>在遇到异常时，请考虑配置是否符合上述条件。</p>
<p>此处，使用Proxy Protocol让被回落到的目标获取到客户端的真实IP。</p>
<p>另外，当Xray的某个入站配置存在<code>&quot;acceptProxyProtocol&quot;: true</code>时，ReadV将失效。</p>
<ol start="2">
<li>有关HTTP/2</li>
</ol>
<p>首先，<code>inbounds.streamSettings.xtlsSettings.alpn</code>有顺序，应将<code>h2</code>放前，<code>http/1.1</code>放后，在优先使用HTTP/2的同时保证兼容性；反过来会导致HTTP/2在协商时变为 HTTP/1.1，成为无效配置。</p>
<p>在上述配置中，每条回落到Nginx的配置都要分成两个。这是因为h2是强制TLS加密的HTTP/2连接，这有益于数据在互联网中传输的安全，但在服务器内部没有必要；而h2c是非加密的HTTP/2连接，适合该环境。然而，Nginx不能在同一端口上同时监听HTTP/1.1和h2c，为了解决这个问题，需要在回落中指定alpn项，以尝试匹配TLS ALPN协商结果。</p>
<p>使用Caddy就不必如此繁杂了，因为它可以在同一端口上同时监听HTTP/1.1和h2c，配置改动如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-json" data-lang="json"><span style="color:#d14">&#34;fallbacks&#34;</span><span style="color:#a61717;background-color:#e3d2d2">:</span> [
  {
    <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;ws.example.com&#34;</span>,
    <span style="color:#000080">&#34;path&#34;</span>: <span style="color:#d14">&#34;/vmessws&#34;</span>,
    <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6000</span>,
    <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
  },
  {
    <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6001</span>,
    <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
  },
  {
    <span style="color:#000080">&#34;name&#34;</span>: <span style="color:#d14">&#34;example.com&#34;</span>,
    <span style="color:#000080">&#34;dest&#34;</span>: <span style="color:#099">6002</span>,
    <span style="color:#000080">&#34;xver&#34;</span>: <span style="color:#099">1</span>
  }
]
</code></pre></td></tr></table>
</div>
</div><h2 id="nginx配置">Nginx配置</h2>
<p>Nginx将通过官方源进行安装。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">6
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt install curl gnupg2 ca-certificates lsb-release
<span style="color:#0086b3">echo</span> <span style="color:#d14">&#34;deb http://nginx.org/packages/debian `lsb_release -cs` nginx&#34;</span> <span style="color:#d14">\
</span><span style="color:#d14"></span>    | tee /etc/apt/sources.list.d/nginx.list
curl -fsSL https://nginx.org/keys/nginx_signing.key | apt-key add -
apt update
apt install nginx
</code></pre></td></tr></table>
</div>
</div><p>创建并编辑<code>vim /etc/nginx/sites-available/example.com</code>文件，内容如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#000;font-weight:bold">set_real_ip_from</span> <span style="color:#099">127</span><span style="color:#d14">.0.0.1</span>;
<span style="color:#000;font-weight:bold">real_ip_header</span> <span style="color:#d14">proxy_protocol</span>;

<span style="color:#000;font-weight:bold">server</span> {
    <span style="color:#000;font-weight:bold">listen</span> 127.0.0.1:<span style="color:#099">6001</span> <span style="color:#d14">proxy_protocol</span> <span style="color:#d14">default_server</span>;
    <span style="color:#000;font-weight:bold">listen</span> 127.0.0.1:<span style="color:#099">6002</span> <span style="color:#d14">proxy_protocol</span> <span style="color:#d14">default_server</span> <span style="color:#d14">http2</span>;
    <span style="color:#000;font-weight:bold">root</span> <span style="color:#d14">/var/www/default</span>;
    <span style="color:#000;font-weight:bold">index</span> <span style="color:#d14">index.html</span> <span style="color:#d14">index.php</span>;
}

<span style="color:#000;font-weight:bold">server</span> {
    <span style="color:#000;font-weight:bold">listen</span> 127.0.0.1:<span style="color:#099">6003</span> <span style="color:#d14">proxy_protocol</span>;
    <span style="color:#000;font-weight:bold">listen</span> 127.0.0.1:<span style="color:#099">6004</span> <span style="color:#d14">proxy_protocol</span> <span style="color:#d14">http2</span>;

    <span style="color:#000;font-weight:bold">server_name</span> <span style="color:#d14">example.com</span>;
    <span style="color:#000;font-weight:bold">root</span> <span style="color:#d14">/var/www</span>;
    <span style="color:#000;font-weight:bold">index</span> <span style="color:#d14">index.html</span> <span style="color:#d14">index.php</span>;

    <span style="color:#000;font-weight:bold">location</span> ~ <span style="color:#009926">\.php$</span> {
        <span style="color:#000;font-weight:bold">fastcgi_pass</span> <span style="color:#d14">unix:/var/run/php/php7.0-fpm.sock</span>;
        <span style="color:#998;font-style:italic"># fastcgi_pass 127.0.0.1:9000;        
</span><span style="color:#998;font-style:italic"></span>        <span style="color:#000;font-weight:bold">fastcgi_param</span> <span style="color:#d14">SCRIPT_FILENAME</span> <span style="color:#008080">$document_root$fastcgi_script_name</span>;
        <span style="color:#000;font-weight:bold">include</span> <span style="color:#d14">fastcgi_params</span>;
    }
}

<span style="color:#000;font-weight:bold">server</span> {
    <span style="color:#000;font-weight:bold">listen</span> <span style="color:#099">80</span>;
    <span style="color:#000;font-weight:bold">return</span> <span style="color:#099">301</span> <span style="color:#d14">https://</span><span style="color:#008080">$host$request_uri</span>;
}
</code></pre></td></tr></table>
</div>
</div><p>重新载入nginx配置，<code>systemctl reload nginx</code>。</p>
<h2 id="caddy配置">Caddy配置</h2>
<p>Caddy将通过官方源进行安装。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">5
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">apt install -y debian-keyring debian-archive-keyring apt-transport-https
curl -1sLf <span style="color:#d14">&#39;https://dl.cloudsmith.io/public/caddy/stable/gpg.key&#39;</span> | apt-key add -
curl -1sLf <span style="color:#d14">&#39;https://dl.cloudsmith.io/public/caddy/stable/debian.deb.txt&#39;</span> | tee /etc/apt/sources.list.d/caddy-stable.list
apt update
apt install caddy
</code></pre></td></tr></table>
</div>
</div><p>为了使Caddy能获取到访问者的真实IP，需要编译带有Proxy Protocol模块的Caddy。建议直接在Caddy官网上在线编译。</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">4
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">systemctl stop caddy
curl -o /usr/bin/caddy <span style="color:#d14">&#34;https://caddyserver.com/api/download?os=linux&amp;arch=amd64&amp;p=github.com%2Fmastercactapus%2Fcaddy2-proxyprotocol&amp;idempotency=79074247675458&#34;</span>
chmod +x /usr/bin/caddy
systemctl start caddy
</code></pre></td></tr></table>
</div>
</div><p>编辑<code>vim /etc/caddy/Caddyfile</code>文件，内容如下：</p>
<div class="highlight"><div style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4">
<table style="border-spacing:0;padding:0;margin:0;border:0;width:auto;overflow:auto;display:block;"><tr><td style="vertical-align:top;padding:0;margin:0;border:0;">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 1
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 2
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 3
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 4
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 5
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 6
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 7
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 8
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f"> 9
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">10
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">11
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">12
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">13
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">14
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">15
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">16
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">17
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">18
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">19
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">20
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">21
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">22
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">23
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">24
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">25
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">26
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">27
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">28
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">29
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">30
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">31
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">32
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">33
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">34
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">35
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">36
</span><span style="margin-right:0.4em;padding:0 0.4em 0 0.4em;color:#7f7f7f">37
</span></code></pre></td>
<td style="vertical-align:top;padding:0;margin:0;border:0;;width:100%">
<pre style="background-color:#fff;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-nginx" data-lang="nginx"><span style="color:#000;font-weight:bold">{</span>
    <span style="color:#d14">servers</span> 127.0.0.1:<span style="color:#099">6001</span> {
        <span style="color:#000;font-weight:bold">listener_wrappers</span> {
            <span style="color:#000;font-weight:bold">proxy_protocol</span>
        <span style="color:#a61717;background-color:#e3d2d2">}</span>
    <span style="color:#d14">protocol</span> {
            <span style="color:#000;font-weight:bold">allow_h2c</span>
        <span style="color:#a61717;background-color:#e3d2d2">}</span>
    <span style="color:#a61717;background-color:#e3d2d2">}</span>
    <span style="color:#d14">servers</span> 127.0.0.1:<span style="color:#099">6002</span> {
        <span style="color:#000;font-weight:bold">listener_wrappers</span> {
            <span style="color:#000;font-weight:bold">proxy_protocol</span>
        <span style="color:#a61717;background-color:#e3d2d2">}</span>
    <span style="color:#d14">protocol</span> {
            <span style="color:#000;font-weight:bold">allow_h2c</span>
        <span style="color:#a61717;background-color:#e3d2d2">}</span>
    <span style="color:#a61717;background-color:#e3d2d2">}</span>
<span style="color:#a61717;background-color:#e3d2d2">}</span>

:<span style="color:#099">6001</span> {
    <span style="color:#000;font-weight:bold">root</span> <span style="color:#d14">*</span> <span style="color:#d14">/var/www/default</span>
    <span style="color:#d14">file_server</span>
    <span style="color:#d14">log</span>
    <span style="color:#d14">bind</span> <span style="color:#099">127</span><span style="color:#d14">.0.0.1</span>
<span style="color:#a61717;background-color:#e3d2d2">}</span>

:<span style="color:#099">6002</span> {
    <span style="color:#000;font-weight:bold">root</span> <span style="color:#d14">*</span> <span style="color:#d14">/var/www/qoant</span>
    <span style="color:#d14">php_fastcgi</span> <span style="color:#d14">unix//run/php/php7.0-fpm.sock</span>
    <span style="color:#d14">file_server</span>
    <span style="color:#d14">log</span>
    <span style="color:#d14">bind</span> <span style="color:#099">127</span><span style="color:#d14">.0.0.1</span>
<span style="color:#a61717;background-color:#e3d2d2">}</span>

:<span style="color:#099">80</span> {
    <span style="color:#000;font-weight:bold">redir</span> <span style="color:#d14">https://</span>{<span style="color:#000;font-weight:bold">host}{uri}</span> <span style="color:#d14">permanent</span>
<span style="color:#a61717;background-color:#e3d2d2">}</span>
</code></pre></td></tr></table>
</div>
</div><p>重新载入caddy配置，<code>systemctl reload caddy</code>。</p>

        </div>

        
<div class="post-archive">
    <ul class="post-copyright">
        <li><strong>原文作者：</strong><a rel="author" href="https://qoanty.github.io/">百年孤独</a></li>
        <li style="word-break:break-all"><strong>原文链接：</strong><a href="https://qoanty.github.io/2021/04/xray-fallbacks-sni/">https://qoanty.github.io/2021/04/xray-fallbacks-sni/</a></li>
        <li><strong>版权声明：</strong>本作品采用<a rel="license" href="https://creativecommons.org/licenses/by-nc-nd/4.0/">知识共享署名-非商业性使用-禁止演绎 4.0 国际许可协议</a>进行许可，非商业转载请注明出处（作者，原文链接），商业转载请联系作者获得授权。</li>
    </ul>
</div>
<br/>



        

<div class="post-archive">
    <h2>See Also</h2>
    <ul class="listing">
        
        <li><a href="/2021/04/xray-vless-fallbacks/">Xray VLESS协议的fallback功能简析</a></li>
        
        <li><a href="/2021/04/vps-with-xray/">Xray教程</a></li>
        
        <li><a href="/2021/03/v2ray-vless-fallbacks/">VLESS协议的fallback参数介绍</a></li>
        
        <li><a href="/2021/03/v2ray-vless-protocal/">V2ray的VLESS协议介绍和使用</a></li>
        
        <li><a href="/2021/02/vps-caddy2/">Caddy 2安装与配置</a></li>
        
    </ul>
</div>


        <div class="post-meta meta-tags">
            
            <ul class="clearfix">
                
                <li><a href='/tags/xray'>xray</a></li>
                
                <li><a href='/tags/sni'>SNI</a></li>
                
            </ul>
            
        </div>
    </article>
    
    

    
    
</div>

                    <footer id="footer">
    <div>
        &copy; 2021 <a href="https://qoanty.github.io/">百年孤独的博客 By 百年孤独</a>
        
    </div>
    <br />
    <div>
        <div class="github-badge">
            <a href="https://gohugo.io/" target="_black" rel="nofollow"><span class="badge-subject">Powered by </span><span class="badge-value bg-blue">Hugo.</span></a>
        </div>
        <div class="github-badge">
            <a href="https://github.com/flysnow-org/maupassant-hugo" target="_black"><span class="badge-subject">Theme base on </span><span class="badge-value bg-yellowgreen">Maupassant.</span></a>
        </div>
    </div>
</footer>


    
    <script type="text/javascript">
        window.MathJax = {
            tex2jax: {
                inlineMath: [['$', '$']],
                processEscapes: true
                }
            };
    </script>
    <script src='https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js?config=TeX-MML-AM_CHTML' async></script>

<a id="rocket" href="#top"></a>
<script type="text/javascript" src='/js/totop.js?v=0.0.0' async=""></script>







                </div>

                <div id="secondary">
    <section class="widget">
        <form id="search" action='https://qoanty.github.io/search/' method="get" accept-charset="utf-8" target="_blank" _lpchecked="1">
      
      <input type="text" name="q" maxlength="20" placeholder="Search">
      <input type="hidden" name="sitesearch" value="https://qoanty.github.io/">
      <button type="submit" class="submit icon-search"></button>
</form>
    </section>
    
    <section class="widget">
        <h3 class="widget-title">最近文章</h3>
<ul class="widget-list">
    
    <li>
        <a href="https://qoanty.github.io/2021/05/xray-nginx-sni/" title="Nginx SNI分流（端口复用）使用Xray&#43;VLESS&#43;XTLS">Nginx SNI分流（端口复用）使用Xray&#43;VLESS&#43;XTLS</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2021/04/xray-fallbacks-sni/" title="Xray通过SNI回落功能实现伪装与按域名分流">Xray通过SNI回落功能实现伪装与按域名分流</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2021/04/xray-vless-fallbacks/" title="Xray VLESS协议的fallback功能简析">Xray VLESS协议的fallback功能简析</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2021/04/vps-with-xray/" title="Xray教程">Xray教程</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2021/03/v2ray-vless-fallbacks/" title="VLESS协议的fallback参数介绍">VLESS协议的fallback参数介绍</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2021/03/v2ray-vless-protocal/" title="V2ray的VLESS协议介绍和使用">V2ray的VLESS协议介绍和使用</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2021/02/vps-caddy2/" title="Caddy 2安装与配置">Caddy 2安装与配置</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2020/07/install-manjaro-kde/" title="Manjaro-KDE 安装与设置">Manjaro-KDE 安装与设置</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2020/06/vps-with-trojan-go/" title="Trojan-Go 安装配置教程">Trojan-Go 安装配置教程</a>
    </li>
    
    <li>
        <a href="https://qoanty.github.io/2019/10/tensorflow-without-phd/" title="Tensorflow, Keras and deep learning, without a Phd">Tensorflow, Keras and deep learning, without a Phd</a>
    </li>
    
</ul>
    </section>

    

    <section class="widget">
        <h3 class="widget-title"><a href='/categories/'>分类</a></h3>
<ul class="widget-list">
    
    <li><a href="https://qoanty.github.io/categories/blog/">Blog (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/caddy/">Caddy (2)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/captcha/">Captcha (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/debian/">Debian (5)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/docker/">Docker (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/hugo/">Hugo (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/kde/">KDE (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/kms/">KMS (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/learn/">Learn (14)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/manjaro/">Manjaro (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/nginx/">Nginx (2)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/pipenv/">Pipenv (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/python/">Python (12)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/sni/">SNI (2)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/ssh/">SSH (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/tensorflow/">TensorFlow (5)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/trojan/">Trojan (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/trojan-go/">Trojan-Go (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/v2ray/">v2ray (4)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/vim/">Vim (1)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/vless/">VLESS (3)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/vps/">VPS (9)</a></li>
    
    <li><a href="https://qoanty.github.io/categories/xray/">xray (4)</a></li>
    
</ul>
    </section>

    <section class="widget">
        <h3 class="widget-title"><a href='/tags/'>标签</a></h3>
<div class="tagcloud">
    
    <a href="https://qoanty.github.io/tags/asyncio/">asyncio</a>
    
    <a href="https://qoanty.github.io/tags/caddy/">Caddy</a>
    
    <a href="https://qoanty.github.io/tags/cdn/">CDN</a>
    
    <a href="https://qoanty.github.io/tags/data/">data</a>
    
    <a href="https://qoanty.github.io/tags/debian/">Debian</a>
    
    <a href="https://qoanty.github.io/tags/deep-learning/">deep learning</a>
    
    <a href="https://qoanty.github.io/tags/docker/">Docker</a>
    
    <a href="https://qoanty.github.io/tags/features/">features</a>
    
    <a href="https://qoanty.github.io/tags/functions/">functions</a>
    
    <a href="https://qoanty.github.io/tags/geetest/">geetest</a>
    
    <a href="https://qoanty.github.io/tags/github/">Github</a>
    
    <a href="https://qoanty.github.io/tags/hugo/">Hugo</a>
    
    <a href="https://qoanty.github.io/tags/ide/">IDE</a>
    
    <a href="https://qoanty.github.io/tags/kde/">KDE</a>
    
    <a href="https://qoanty.github.io/tags/keras/">keras</a>
    
    <a href="https://qoanty.github.io/tags/kms/">KMS</a>
    
    <a href="https://qoanty.github.io/tags/manjaro/">Manjaro</a>
    
    <a href="https://qoanty.github.io/tags/nginx/">Nginx</a>
    
    <a href="https://qoanty.github.io/tags/oop/">OOP</a>
    
    <a href="https://qoanty.github.io/tags/pipenv/">Pipenv</a>
    
    <a href="https://qoanty.github.io/tags/processes/">processes</a>
    
    <a href="https://qoanty.github.io/tags/python/">Python</a>
    
    <a href="https://qoanty.github.io/tags/scraping/">scraping</a>
    
    <a href="https://qoanty.github.io/tags/sni/">SNI</a>
    
    <a href="https://qoanty.github.io/tags/ssh/">SSH</a>
    
    <a href="https://qoanty.github.io/tags/tensorflow/">tensorflow</a>
    
    <a href="https://qoanty.github.io/tags/trojan/">Trojan</a>
    
    <a href="https://qoanty.github.io/tags/trojan-go/">Trojan-Go</a>
    
    <a href="https://qoanty.github.io/tags/v2ray/">v2ray</a>
    
    <a href="https://qoanty.github.io/tags/vim/">Vim</a>
    
    <a href="https://qoanty.github.io/tags/vless/">VLESS</a>
    
    <a href="https://qoanty.github.io/tags/vps/">VPS</a>
    
    <a href="https://qoanty.github.io/tags/xray/">xray</a>
    
</div>
    </section>

    
<section class="widget">
    <h3 class="widget-title">友情链接</h3>
    <ul class="widget-list">
        
        <li>
            <a target="_blank" href="https://python3-cookbook.readthedocs.io/zh_CN/latest/index.html" title="Python Cookbook 3rd Edition">Python Cookbook</a>
        </li>
        
        <li>
            <a target="_blank" href="https://seancheney.gitbook.io/python-for-data-analysis-2nd/" title="Python for Data Analysis 2nd Edition">Python for Data Analysis</a>
        </li>
        
        <li>
            <a target="_blank" href="https://codelabs.developers.google.com/codelabs/cloud-tensorflow-mnist/#0" title="TensorFlow and deep learning, without a PhD">TensorFlow and deep learning</a>
        </li>
        
    </ul>
</section>


    <section class="widget">
        <h3 class="widget-title">其它</h3>
        <ul class="widget-list">
            <li><a href="https://qoanty.github.io/index.xml">文章 RSS</a></li>
        </ul>
    </section>
</div>
            </div>
        </div>
    </div>
</body>

</html>